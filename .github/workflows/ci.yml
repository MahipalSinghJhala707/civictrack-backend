# =============================================================================
# Backend CI Pipeline
# =============================================================================
# 
# PURPOSE:
# Validate code correctness on every push and pull request.
# This pipeline does NOT deploy, provision infrastructure, or require cloud credentials.
#
# SCOPE:
# - Install dependencies
# - Run tests (with PostgreSQL service for integration tests)
# - Fail fast on any error
#
# EXTENDING THIS PIPELINE:
# - To add linting: uncomment the lint step and add eslint config to the project
# - To add deployment: create a separate workflow file (e.g., deploy.yml)
# - To add more test types: add additional steps after the test step
# =============================================================================

name: CI

# Disabled automatic triggers; CI can be run manually if needed
on:
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    # PostgreSQL service for integration tests
    # Tests require a real database connection (auth.test.js uses Sequelize)
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: civictrack_test
          POSTGRES_PASSWORD: civictrack_test_pass
          POSTGRES_DB: civictrack_test
        ports:
          - 5432:5432
        # Health check to ensure postgres is ready before tests run
        options: >-
          --health-cmd="pg_isready -U civictrack_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      # Database configuration for tests
      NODE_ENV: test
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: civictrack_test
      DB_USER: civictrack_test
      DB_PASS: civictrack_test_pass
      # JWT secret for auth tests (not a real secret, CI-only)
      JWT_SECRET: ci-test-jwt-secret-not-for-production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Run database migrations before tests
      # This ensures the test database has the correct schema
      - name: Run migrations
        run: npm run db:migrate

      - name: Run tests
        run: npm test

      # =======================================================================
      # OPTIONAL: Uncomment to enable linting
      # Requires eslint to be configured in the project (eslint.config.js)
      # =======================================================================
      # - name: Run linter
      #   run: npm run lint

      # =======================================================================
      # OPTIONAL: Uncomment to verify the app starts correctly
      # Useful for catching runtime initialization errors
      # =======================================================================
      # - name: Verify app starts
      #   run: |
      #     timeout 10s npm start || exit_code=$?
      #     if [ "$exit_code" -eq 124 ]; then
      #       echo "App started successfully (timed out as expected)"
      #     else
      #       echo "App failed to start"
      #       exit 1
      #     fi


#disabled